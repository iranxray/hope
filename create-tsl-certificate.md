# ساخت TLS Certificate

برای اینکه کاربران ما نسبت به ایمنی داده‌های‌شان در برابر دیواره GFW‌ مطمئن باشند، ما می‌بایست داده‌های شان را با پروتکل‌های TLS و یا XTLS رمزنگاری کنیم. برای این رمزنگاری ما نیاز خواهیم داشت که بر روی سرور لینوکسی خود کلیدهای رمزنگاری یا certificate داشته باشیم. در این مستند شرح خواهیم داد که این کلیدها چگونه ساخته خواهند شد.

برای ساخت کلید رمزنگاری دو روش Self-Signed و Let's Encrypt را شرح خواهیم داد. فکر می‌کنیم برای کاربران عادی، استفاده از روش Self-Signed راحت‌‌تر می‌باشد. اگر صاحب دامنه هستید و نیاز به امنیت بیشتر دارید، می‌توانید از روش Let's Encrypt‌ استفاده کنید.


# ساخت کلید رمزنگاری به روش Self-Signed (برای کاربران مبتدی)


۲. با دستور زیر، سطح اختیارات را بالا می‌بریم.

```bash
sudo -i
```


۳. با دستور زیر، بانک اطلاعاتی اپلیکیشن‌های لینوکس را به روز می‌کنیم.



```bash
apt update && apt upgrade -y
```

۴. با دستور زیر، openssl را نصب می‌کنیم.


```bash
sudo apt-get install openssl
```

۵. با دستور زیر، کلیدهای رمزنگاری را بر روی سیستم تعریف می‌کنیم. دستور زیر دو فایل به نام private.key و cert.pem بر روی سرور شما ایجاد می‌کند.


```bash
openssl req -x509 -newkey rsa:4096 -keyout private.key -out cert.pem -sha256 -days 365 -nodes
```

۶. دستور قبلی، سوال‌هایی را از شما می‌پرسد. نیازی به پاسخ دادن هیچ کدام از سوال‌ها نیست مگر برای سوال Common Name که نام دامنه را از شما می‌پرسد.

![image](https://user-images.githubusercontent.com/118040490/201593200-90fc980c-102b-4620-b922-21f7bea72ffe.png)

در تصویر فوق مشاهده می‌کنید که ما از دامنه فرضی iranxray.hope.com استفاده کرده ایم. شما می‌توانید هر نام دلخواهی را استفاده کنید.  این دامنه را یادداشت کنید، چون در حین ساخت VLESS و Trojan به آن نیاز خواهیم داشت.

۷. با دستور زیر، به X-UI دسترسی خواهیم داد که فایل‌های ساخته شده برای رمزنگاری استفاده کند.

```bash
chmod ugo+rwx cert.pem
chmod ugo+rwx private.key
```


۸. حال دو فایل بر روی سیستم شما ساخته شده. برای گرفتن آدرس کامل فایل‌ certificate دستور زیر را وارد کنید. نتیجه را یادداشت نمایید چون باید این آدرس را باید در X-UI وارد نمایید.


```bash
echo "$(pwd)/cert.pem"
```

و برای گرفتن آدرس کامل کلید خصوصی دستور زیر را وارد کنید. نتیجه را یادداشت نمایید چون باید این آدرس را باید در X-UI وارد نمایید


```bash
echo "$(pwd)/private.key"
```

۹. تمام. برای راه‌اندازی پروتکل‌های VLESS و Trojan به دامنه و آدرس فایل‌هایی که در مراحل قبل یادداشت کردید، نیاز خواهیم داشت.

# ساخت کلید رمزنگاری معتبر با استفاده از Let's Encrypt (برای کاربران خفن!)

این مرحله حکم پرتاب سه امتیازی دارد و برای اکثر کاربرها لازم نیست. گرفتن کلید رمزنگاری معتبر از Let's Encrypt نیاز به خرید domain واقعی و انجام برخی تنظیمات دارد که برای کاربرهای مبتدی‌تر دشوار می‌باشد. همان روش Self-Signed کار راه‌انداز هست.

۱. پیش از طی این مراحل لطفا اطمینان حاصل کنید که پورت 80 بر روی سرور لینوکسی شما باز می‌باشد. اپلیکیشن certbot نیاز دارد تا اطلاعات کلید را از روی این پورت دریافت کند.


۲. ابتدا با دستور زیر، سطح اختیارات را بالا می‌بریم.

```bash
sudo -i
```


۳. با دستور زیر، بانک اطلاعاتی اپلیکیشن‌های لینوکس را به روز می‌کنیم.



```bash
apt update && apt upgrade -y
```

۴. حالا certbot را نصب می‌کنیم تا بتوانیم به لطف پروژه Let's Encrypt کلیدهای معتبر TLS بسازیم.


```bash
sudo apt-get install certbot
```

۵. بعد از نصب، دستور زیر را اجرا کنید تا کلیدهای رمزنگاری بر روی سیستم شما ساخته شود. در دستور پایین، از ایمیل فرضی test@email.com و دامنه فرضی iran-free-xray.com  استفاده کرده‌ایم. شما می‌توانید به دلخواه این مقادیر را تغییر دهید. البته نام دامنه‌ای که انتخاب می‌کنید باید واقعی بوده باشد و NameServer ها بایستی به آدرس IP شما اشاره کنند.

```bash
sudo certbot certonly --standalone --preferred-challenges http --agree-tos --email test@email.com -d iran-free-xray.com 
```
